# Production Docker Compose Override
# Customizes base docker-compose.yml for production VPS

version: '3.8'

services:
  # Override backend for production
  backend:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: always
    environment:
      # Override with production values
      ENVIRONMENT: production
      LOG_LEVEL: warn
      # Add production monitoring
      SENTRY_DSN: ${SENTRY_DSN}

  # Override frontend for production
  frontend:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    restart: always
    environment:
      # Production API URL
      VITE_API_URL: https://api.blytz.live/api/v1
      VITE_SENTRY_DSN: ${VITE_SENTRY_DSN}
      VITE_GOOGLE_ANALYTICS_ID: ${VITE_GOOGLE_ANALYTICS_ID}

  # Add production monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: blytz-prometheus
    restart: always
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    networks:
      - blytz-network

  grafana:
    image: grafana/grafana:latest
    container_name: blytz-grafana
    restart: always
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana:/etc/grafana/provisioning
    networks:
      - blytz-network

  # Add backup service
  backup:
    image: postgres:15-alpine
    container_name: blytz-backup
    restart: "no"
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./scripts/backup.sh:/backup.sh
      - backup_data:/backups
    entrypoint: |
      sh -c "
        while true; do
          echo 'Running backup...'
          PGPASSWORD=$${POSTGRES_PASSWORD} pg_dump -h postgres -U ${POSTGRES_USER:-blytz_user} -d ${POSTGRES_DB:-blytz_marketplace} > /backups/backup_$$(date +%Y%m%d_%H%M%S).sql
          find /backups -name '*.sql' -mtime +${BACKUP_RETENTION_DAYS:-30} -delete
          echo 'Backup completed. Next backup in 24 hours.'
          sleep 86400
        done
      "
    depends_on:
      - postgres
    networks:
      - blytz-network

volumes:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  backup_data:
    driver: local

networks:
  blytz-network:
    driver: bridge
    external: true